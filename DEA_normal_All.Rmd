---
title: "DEA_all_normal"
output: html_document
date: "2025-08-27"
---

```{r}
############################################################
# DEA: GTEx Pancreas (Normal) — High vs Low MIR100HG
############################################################

# if (!requireNamespace("BiocManager", quietly = TRUE)) install.packages("BiocManager")
# BiocManager::install("limma")
library(limma)

strat_path <- "/Users/shreyababare/Desktop/Data Science Final Project/mir100HG_FIN/output/GTEx_Pancreas_MIR100HG_top25_bottom25_stratification.csv"
expr_path  <- "/Users/shreyababare/Desktop/Data Science Final Project/mir100HG_FIN/output/GTEX_pancreas_filtered_expression_proteinCoding_plus_MIR100HG.csv"
outdir     <- "/Users/shreyababare/Desktop/Data Science Final Project/mir100HG_FIN/output/Paad_DEA_normal"

df <- read.csv(expr_path, check.names = FALSE, stringsAsFactors = FALSE)
stopifnot(all(c("gene_ID","HGNC_symbol","biotype") %in% colnames(df)))
rownames(df) <- df$gene_ID

symbol_map <- df$HGNC_symbol; names(symbol_map) <- rownames(df)

df$gene_ID <- NULL
df$HGNC_symbol <- NULL
df$biotype <- NULL


expr <- as.matrix(apply(df, 2, function(x) as.numeric(as.character(x))))
rownames(expr) <- rownames(df)

min_val <- min(expr, na.rm = TRUE)
expected_floor <- log2(0.001)
if (abs(min_val - expected_floor) < 1e-3) {
  message(sprintf("OK: detected floor ~ log2(0.001) = %.4f; min = %.4f", expected_floor, min_val))
} else {
  warning(sprintf("Min %.4f not ~ log2(0.001)=%.4f. Verify scale.", min_val, expected_floor))
}

strat <- read.csv(strat_path, stringsAsFactors = FALSE)
strat <- strat[strat$MIR100HG_Group %in% c("High_MIR100HG","Low_MIR100HG"), ]

samples <- intersect(strat$Sample_ID, colnames(expr))
if (length(samples) < 6) warning("Very few overlapping samples — check IDs.")
strat <- strat[match(samples, strat$Sample_ID), ]
expr_hilo <- expr[, samples, drop = FALSE]
group <- factor(strat$MIR100HG_Group, levels = c("Low_MIR100HG","High_MIR100HG"))

APPLY_QN <- FALSE
if (APPLY_QN) {
  expr_hilo <- normalizeBetweenArrays(expr_hilo, method = "quantile")
}

keep <- apply(expr_hilo, 1, function(x) var(x, na.rm = TRUE) > 0)
expr_hilo <- expr_hilo[keep, , drop = FALSE]

design <- model.matrix(~ 0 + group)
colnames(design) <- levels(group)
fit <- lmFit(expr_hilo, design)
contrast <- makeContrasts(High_MIR100HG - Low_MIR100HG, levels = design)
fit2 <- eBayes(contrasts.fit(fit, contrast), trend = TRUE, robust = TRUE)

tt <- topTable(fit2, number = Inf, sort.by = "P")
tt$HGNC_symbol <- symbol_map[rownames(tt)]

write_deg_sets <- function(tt, prefix, fdr_levels = c(0.05, 0.01, 0.001), lfc_min = 1) {
  dir.create(outdir, showWarnings = FALSE, recursive = TRUE)
  full_path <- file.path(outdir, paste0(prefix, "_full_results.tsv"))
  write.table(tt, full_path, sep = "\t", quote = FALSE, row.names = TRUE)
  message("Wrote: ", full_path)
  for (q in fdr_levels) {
    filt <- tt[tt$adj.P.Val <= q & abs(tt$logFC) >= lfc_min, , drop = FALSE]
    up   <- filt[filt$logFC >=  lfc_min, , drop = FALSE]
    down <- filt[filt$logFC <= -lfc_min, , drop = FALSE]
    base <- paste0(prefix, "_FDR", gsub("\\.", "", sprintf("%.3f", q)), "_LFC", lfc_min)
    write.table(filt, file.path(outdir, paste0(base, "_ALL.tsv")),  sep = "\t", quote = FALSE, row.names = TRUE)
    write.table(up,   file.path(outdir, paste0(base, "_UP.tsv")),   sep = "\t", quote = FALSE, row.names = TRUE)
    write.table(down, file.path(outdir, paste0(base, "_DOWN.tsv")), sep = "\t", quote = FALSE, row.names = TRUE)
    message(sprintf("FDR<=%.3f & |log2FC|>=%.1f -> ALL:%d UP:%d DOWN:%d",
                    q, lfc_min, nrow(filt), nrow(up), nrow(down)))
  }
}

write_deg_sets(tt, prefix = "DEA_GTEX_Pancreas_Normal_High_vs_Low")

cat("\nGroup sizes:\n"); print(table(group))
want <- c("HGNC_symbol","logFC","P.Value","adj.P.Val")
have <- intersect(want, colnames(tt))
top <- head(tt[order(tt$adj.P.Val, tt$P.Value), have, drop = FALSE], 10)

```




```{r}
############################################################
# DEA: GTEx Skin (Normal) — High vs Low MIR100HG 
############################################################

# if (!requireNamespace("BiocManager", quietly = TRUE)) install.packages("BiocManager")
# BiocManager::install("limma")
library(limma)

strat_path <- "/Users/shreyababare/Desktop/Data Science Final Project/mir100HG_FIN/output/GTEX_skin_MIR100HG_top25_bottom25_stratification.csv"
expr_path  <- "/Users/shreyababare/Desktop/Data Science Final Project/mir100HG_FIN/output/filtered_expression_protein_coding_plus_MIR100HG_GTEX_skin.csv"
outdir     <- "/Users/shreyababare/Desktop/Data Science Final Project/mir100HG_FIN/output/DEA_SKCM"

df <- read.csv(expr_path, check.names = FALSE, stringsAsFactors = FALSE)

stopifnot(all(c("gene_ID","HGNC_symbol","biotype") %in% colnames(df)))
rownames(df) <- df$gene_ID

symbol_map <- df$HGNC_symbol; names(symbol_map) <- rownames(df)

df$gene_ID <- NULL
df$HGNC_symbol <- NULL
df$biotype <- NULL

expr <- as.matrix(apply(df, 2, function(x) as.numeric(as.character(x))))
rownames(expr) <- rownames(df)

min_val <- min(expr, na.rm = TRUE)
expected_floor <- log2(0.001)
if (abs(min_val - expected_floor) < 1e-3) {
  message(sprintf("OK: detected floor ~ log2(0.001) = %.4f; min = %.4f", expected_floor, min_val))
} else {
  warning(sprintf("Min %.4f not ~ log2(0.001)=%.4f. Verify scale.", min_val, expected_floor))
}

strat <- read.csv(strat_path, stringsAsFactors = FALSE)
strat <- strat[strat$MIR100HG_Group %in% c("High_MIR100HG","Low_MIR100HG"), ]

samples <- intersect(strat$Sample_ID, colnames(expr))
if (length(samples) < 6) warning("Very few overlapping samples — check IDs.")
strat <- strat[match(samples, strat$Sample_ID), ]
expr_hilo <- expr[, samples, drop = FALSE]


group <- factor(strat$MIR100HG_Group, levels = c("Low_MIR100HG","High_MIR100HG"))

APPLY_QN <- FALSE
if (APPLY_QN) {
  expr_hilo <- normalizeBetweenArrays(expr_hilo, method = "quantile")
}


keep <- apply(expr_hilo, 1, function(x) var(x, na.rm = TRUE) > 0)
expr_hilo <- expr_hilo[keep, , drop = FALSE]
design <- model.matrix(~ 0 + group)
colnames(design) <- levels(group)
fit <- lmFit(expr_hilo, design)
contrast <- makeContrasts(High_MIR100HG - Low_MIR100HG, levels = design)
fit2 <- eBayes(contrasts.fit(fit, contrast), trend = TRUE, robust = TRUE)

tt <- topTable(fit2, number = Inf, sort.by = "P")
tt$HGNC_symbol <- symbol_map[rownames(tt)]

write_deg_sets <- function(tt, prefix, fdr_levels = c(0.05, 0.01, 0.001), lfc_min = 1) {
  dir.create(outdir, showWarnings = FALSE, recursive = TRUE)
  full_path <- file.path(outdir, paste0(prefix, "_full_results.tsv"))
  write.table(tt, full_path, sep = "\t", quote = FALSE, row.names = TRUE)
  message("Wrote: ", full_path)
  for (q in fdr_levels) {
    filt <- tt[tt$adj.P.Val <= q & abs(tt$logFC) >= lfc_min, , drop = FALSE]
    up   <- filt[filt$logFC >=  lfc_min, , drop = FALSE]
    down <- filt[filt$logFC <= -lfc_min, , drop = FALSE]
    base <- paste0(prefix, "_FDR", gsub("\\.", "", sprintf("%.3f", q)), "_LFC", lfc_min)
    write.table(filt, file.path(outdir, paste0(base, "_ALL.tsv")),  sep = "\t", quote = FALSE, row.names = TRUE)
    write.table(up,   file.path(outdir, paste0(base, "_UP.tsv")),   sep = "\t", quote = FALSE, row.names = TRUE)
    write.table(down, file.path(outdir, paste0(base, "_DOWN.tsv")), sep = "\t", quote = FALSE, row.names = TRUE)
    message(sprintf("FDR<=%.3f & |log2FC|>=%.1f -> ALL:%d UP:%d DOWN:%d",
                    q, lfc_min, nrow(filt), nrow(up), nrow(down)))
  }
}

write_deg_sets(tt, prefix = "DEA_GTEX_Skin_Normal_High_vs_Low")

# ---- Quick console peek (safe printing) ----
cat("\nGroup sizes:\n"); print(table(group))
want <- c("HGNC_symbol","logFC","P.Value","adj.P.Val")
have <- intersect(want, colnames(tt))
top <- head(tt[order(tt$adj.P.Val, tt$P.Value), have, drop = FALSE], 10)

```

# For lung normal

```{r}
############################################################
# DEA: GTEx Lung (Normal) — High vs Low MIR100HG 
############################################################

# if (!requireNamespace("BiocManager", quietly = TRUE)) install.packages("BiocManager")
# BiocManager::install("limma")
library(limma)

strat_path <- "/Users/shreyababare/Desktop/Data Science Final Project/mir100HG_FIN/output/GTEX_lung_MIR100HG_top25_bottom25_stratification.csv"
expr_path  <- "/Users/shreyababare/Desktop/Data Science Final Project/mir100HG_FIN/output/GTEX_lung_filtered_expression_proteinCoding_plus_MIR100HG.csv"
outdir     <- "/Users/shreyababare/Desktop/Data Science Final Project/mir100HG_FIN/output/DEA_LUAD"

df <- read.csv(expr_path, check.names = FALSE, stringsAsFactors = FALSE)
stopifnot(all(c("gene_ID","HGNC_symbol","biotype") %in% colnames(df)))
rownames(df) <- df$gene_ID

symbol_map <- df$HGNC_symbol; names(symbol_map) <- rownames(df)

df$gene_ID <- NULL
df$HGNC_symbol <- NULL
df$biotype <- NULL

expr <- as.matrix(apply(df, 2, function(x) as.numeric(as.character(x))))
rownames(expr) <- rownames(df)

min_val <- min(expr, na.rm = TRUE)
expected_floor <- log2(0.001)
if (abs(min_val - expected_floor) < 1e-3) {
  message(sprintf("OK: detected floor ~ log2(0.001) = %.4f; min = %.4f", expected_floor, min_val))
} else {
  warning(sprintf("Min %.4f not ~ log2(0.001)=%.4f. Verify scale.", min_val, expected_floor))
}

strat <- read.csv(strat_path, stringsAsFactors = FALSE)
strat <- strat[strat$MIR100HG_Group %in% c("High_MIR100HG","Low_MIR100HG"), ]

samples <- intersect(strat$Sample_ID, colnames(expr))
if (length(samples) < 6) warning("Very few overlapping samples — check IDs.")
strat <- strat[match(samples, strat$Sample_ID), ]
expr_hilo <- expr[, samples, drop = FALSE]

group <- factor(strat$MIR100HG_Group, levels = c("Low_MIR100HG","High_MIR100HG"))

APPLY_QN <- FALSE
if (APPLY_QN) {
  expr_hilo <- normalizeBetweenArrays(expr_hilo, method = "quantile")
}

keep <- apply(expr_hilo, 1, function(x) var(x, na.rm = TRUE) > 0)
expr_hilo <- expr_hilo[keep, , drop = FALSE]

design <- model.matrix(~ 0 + group)
colnames(design) <- levels(group)
fit <- lmFit(expr_hilo, design)
contrast <- makeContrasts(High_MIR100HG - Low_MIR100HG, levels = design)
fit2 <- eBayes(contrasts.fit(fit, contrast), trend = TRUE, robust = TRUE)

tt <- topTable(fit2, number = Inf, sort.by = "P")
tt$HGNC_symbol <- symbol_map[rownames(tt)]

write_deg_sets <- function(tt, prefix, fdr_levels = c(0.05, 0.01, 0.001), lfc_min = 1) {
  dir.create(outdir, showWarnings = FALSE, recursive = TRUE)
  full_path <- file.path(outdir, paste0(prefix, "_full_results.tsv"))
  write.table(tt, full_path, sep = "\t", quote = FALSE, row.names = TRUE)
  message("Wrote: ", full_path)
  for (q in fdr_levels) {
    filt <- tt[tt$adj.P.Val <= q & abs(tt$logFC) >= lfc_min, , drop = FALSE]
    up   <- filt[filt$logFC >=  lfc_min, , drop = FALSE]
    down <- filt[filt$logFC <= -lfc_min, , drop = FALSE]
    base <- paste0(prefix, "_FDR", gsub("\\.", "", sprintf("%.3f", q)), "_LFC", lfc_min)
    write.table(filt, file.path(outdir, paste0(base, "_ALL.tsv")),  sep = "\t", quote = FALSE, row.names = TRUE)
    write.table(up,   file.path(outdir, paste0(base, "_UP.tsv")),   sep = "\t", quote = FALSE, row.names = TRUE)
    write.table(down, file.path(outdir, paste0(base, "_DOWN.tsv")), sep = "\t", quote = FALSE, row.names = TRUE)
    message(sprintf("FDR<=%.3f & |log2FC|>=%.1f -> ALL:%d UP:%d DOWN:%d",
                    q, lfc_min, nrow(filt), nrow(up), nrow(down)))
  }
}

write_deg_sets(tt, prefix = "DEA_GTEX_Lung_Normal_High_vs_Low")
cat("\nGroup sizes:\n"); print(table(group))
want <- c("HGNC_symbol","logFC","P.Value","adj.P.Val")
have <- intersect(want, colnames(tt))
top <- head(tt[order(tt$adj.P.Val, tt$P.Value), have, drop = FALSE], 10)

```
